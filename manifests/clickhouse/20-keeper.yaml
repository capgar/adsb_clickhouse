# ClickHouse Keeper
# Single-node Keeper for ClickHouse coordination
# Provides ZooKeeper-compatible API on port 2181
#
# This is the first deployment using Keeper (previous testing used Zookeeper).
# Keeper is ClickHouse's native coordination service and the recommended approach.

---
apiVersion: v1
kind: Service
metadata:
  name: adsb-keeper-headless
  namespace: clickhouse
spec:
  clusterIP: None
  selector:
    clickhouse-keeper.altinity.com/chk: adsb-keeper
  ports:
    - name: client
      port: 2181
      targetPort: 2181
    - name: raft
      port: 9444
      targetPort: 9444

---
apiVersion: clickhouse-keeper.altinity.com/v1
kind: ClickHouseKeeperInstallation
metadata:
  name: adsb-keeper
  namespace: clickhouse
spec:
  configuration:
    clusters:
      - name: adsb-keeper
        layout:
          replicasCount: 1
    
    settings:
      logger/level: information
      logger/console: "true"
      listen_host: "0.0.0.0"
      keeper_server/storage_path: /var/lib/clickhouse-keeper
      keeper_server/log_storage_path: /var/lib/clickhouse-keeper/logs
      keeper_server/snapshot_storage_path: /var/lib/clickhouse-keeper/snapshots
      keeper_server/coordination_settings/operation_timeout_ms: "10000"
      keeper_server/coordination_settings/session_timeout_ms: "30000"
      keeper_server/coordination_settings/raft_logs_level: information
      keeper_server/raft_configuration/tcp_port: "9444"
  
  defaults:
    templates:
      podTemplate: keeper-pod
      dataVolumeClaimTemplate: keeper-data
  
  templates:
    podTemplates:
      - name: keeper-pod
        spec:
          # CUSTOMIZE: Change to match your target node
          # k3s-homelab: k3s-vm1
          # AWS EKS: Remove or use different selector
          nodeSelector:
            kubernetes.io/hostname: k3s-vm1
          
          containers:
            - name: clickhouse-keeper
              image: altinity/clickhouse-keeper:25.3.8.10041.altinitystable
              ports:
                - name: keeper
                  containerPort: 2181
                - name: raft
                  containerPort: 9444
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
              livenessProbe:
                tcpSocket:
                  port: 2181
                initialDelaySeconds: 30
                periodSeconds: 10
              readinessProbe:
                tcpSocket:
                  port: 2181
                initialDelaySeconds: 10
                periodSeconds: 5
    
    volumeClaimTemplates:
      - name: keeper-data
        spec:
          accessModes:
            - ReadWriteOnce
          # CUSTOMIZE: Change storage class for different environments
          # k3s-homelab: local-path
          # AWS EKS: gp3 or similar
          storageClassName: local-path
          resources:
            requests:
              storage: 10Gi
