# playbooks/05-deploy-schema.yml
# Deploy ClickHouse schema and users

---
- name: Wait for ClickHouse cluster to be fully operational
  block:
    - name: Get first ClickHouse pod
      command: >
        kubectl get pods -n {{ clickhouse_namespace }}
        -l clickhouse.altinity.com/chi=adsb-data
        -o jsonpath='{.items[0].metadata.name}'
      environment: "{{ kubectl_env }}"
      register: first_pod
      changed_when: false

    - name: Set pod name for queries
      set_fact:
        clickhouse_pod: "{{ first_pod.stdout }}"

    - name: Test distributed query capability
      command: >
        kubectl exec -n {{ clickhouse_namespace }} {{ clickhouse_pod }} --
        clickhouse-client --query "SELECT count() FROM clusterAllReplicas('adsb-data', system.one)"
      environment: "{{ kubectl_env }}"
      register: cluster_test
      until: (cluster_test.stdout | int) == (clickhouse_shards | int * clickhouse_replicas | int)
      retries: 30
      delay: 10
      changed_when: false
      failed_when: false

    - name: Verify cluster is operational
      assert:
        that: (cluster_test.stdout | int) == (clickhouse_shards | int * clickhouse_replicas | int)
        fail_msg: "Cluster not ready for distributed queries. Expected {{ clickhouse_shards | int * clickhouse_replicas | int }} responses, got {{ cluster_test.stdout }}"
        success_msg: "Cluster ready - all {{ cluster_test.stdout }} replicas responding to distributed queries"

- name: Deploy schema files
  block:
    - name: Copy schema files to ClickHouse pod
      command: >
        kubectl cp {{ item }}
        {{ clickhouse_namespace }}/{{ clickhouse_pod }}:/tmp/{{ item | basename }}
      environment: "{{ kubectl_env }}"
      loop: "{{ schema_files }}"
      register: schema_copy
      changed_when: schema_copy.rc == 0

    - name: Execute schema files in pod
      shell: >
        kubectl exec -n {{ clickhouse_namespace }} {{ clickhouse_pod }} --
        sh -c "clickhouse-client --multiquery < /tmp/{{ item | basename }}"
      environment: "{{ kubectl_env }}"
      loop: "{{ schema_files }}"
      register: schema_exec
      changed_when: schema_exec.rc == 0

- name: Verify schema deployment
  block:
    - name: List databases
      command: >
        kubectl exec -n {{ clickhouse_namespace }} {{ clickhouse_pod }} --
        clickhouse-client --query "SHOW DATABASES"
      environment: "{{ kubectl_env }}"
      register: databases
      changed_when: false

    - name: List tables in adsb database
      command: >
        kubectl exec -n {{ clickhouse_namespace }} {{ clickhouse_pod }} --
        clickhouse-client --query "SHOW TABLES FROM adsb"
      environment: "{{ kubectl_env }}"
      register: tables
      changed_when: false

    - name: Display schema deployment results
      debug:
        msg:
          - "Schema deployed"
          - "Databases:"
          - "{{ databases.stdout_lines }}"
          - ""
          - "Tables in adsb:"
          - "{{ tables.stdout_lines }}"

- name: Verify tables on all shards
  block:
    - name: Get all ClickHouse pods
      command: >
        kubectl get pods -n {{ clickhouse_namespace }}
        -l clickhouse.altinity.com/chi=adsb-data
        -o jsonpath='{.items[*].metadata.name}'
      environment: "{{ kubectl_env }}"
      register: all_pods
      changed_when: false

    - name: Check tables on each pod
      command: >
        kubectl exec -n {{ clickhouse_namespace }} {{ item }} --
        clickhouse-client --query "SELECT count() FROM system.tables WHERE database = 'adsb'"
      environment: "{{ kubectl_env }}"
      loop: "{{ all_pods.stdout.split() }}"
      register: pod_tables
      changed_when: false

    - name: Verify table consistency
      assert:
        that: pod_tables.results | map(attribute='stdout') | unique | length == 1
        fail_msg: "Table counts differ across pods"
        success_msg: "Tables replicated consistently across all pods"
