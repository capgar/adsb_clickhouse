# ADS-B Scrapers
# Three deployments for different data sources:
# - local: High-frequency polling of local receiver (2s)
# - regional: Medium-frequency polling of airplanes.live (10s) - DISABLED by default
# - global: Low-frequency polling of adsb.lol (30s)
#
# Image: adsb-scraper:latest
# - For k3s: Built locally and imported via k3s ctr
# - For AWS: Will need to push to ECR or Docker Hub

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: adsb-scraper-local
  namespace: adsb-collectors
  labels:
    app: adsb-scraper
    source: local
spec:
  # Local receiver - high frequency
  replicas: 1
  selector:
    matchLabels:
      app: adsb-scraper
      source: local
  template:
    metadata:
      labels:
        app: adsb-scraper
        source: local
    spec:
      affinity:
        nodeAffinity:
          # Prefer designated nodes
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: adsb-collectors
                    operator: Exists
      
      containers:
        - name: scraper
          # CUSTOMIZE: For AWS, change to registry URL
          # k3s-homelab: adsb-scraper:latest
          # AWS EKS: <account>.dkr.ecr.<region>.amazonaws.com/adsb-scraper:latest
          image: adsb-scraper:latest
          imagePullPolicy: IfNotPresent
          
          env:
            - name: SOURCE_TYPE
              value: "local"
          
          envFrom:
            - configMapRef:
                name: scraper-config
          
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          
          livenessProbe:
            exec:
              command: ["python", "-c", "import sys; sys.exit(0)"]
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 5
            failureThreshold: 3

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: adsb-scraper-regional
  namespace: adsb-collectors
  labels:
    app: adsb-scraper
    source: regional
spec:
  # Regional API - medium frequency - DISABLED by default
  # Set replicas: 1 to enable
  replicas: 1
  selector:
    matchLabels:
      app: adsb-scraper
      source: regional
  template:
    metadata:
      labels:
        app: adsb-scraper
        source: regional
    spec:
      affinity:
          nodeAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                preference:
                  matchExpressions:
                    - key: adsb-collectors
                      operator: Exists
      
      containers:
        - name: scraper
          image: adsb-scraper:latest
          imagePullPolicy: IfNotPresent
          
          env:
            - name: SOURCE_TYPE
              value: "regional"
          
          envFrom:
            - configMapRef:
                name: scraper-config
          
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          
          livenessProbe:
            exec:
              command: ["python", "-c", "import sys; sys.exit(0)"]
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 5
            failureThreshold: 3

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: adsb-scraper-global
  namespace: adsb-collectors
  labels:
    app: adsb-scraper
    source: global
spec:
  # Global API - low frequency
  replicas: 1
  selector:
    matchLabels:
      app: adsb-scraper
      source: global
  template:
    metadata:
      labels:
        app: adsb-scraper
        source: global
    spec:
      affinity:
          nodeAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                preference:
                  matchExpressions:
                    - key: adsb-collectors
                      operator: Exists
      
      containers:
        - name: scraper
          image: adsb-scraper:latest
          imagePullPolicy: IfNotPresent
          
          env:
            - name: SOURCE_TYPE
              value: "global"
          
          envFrom:
            - configMapRef:
                name: scraper-config
          
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          
          livenessProbe:
            exec:
              command: ["python", "-c", "import sys; sys.exit(0)"]
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 5
            failureThreshold: 3
