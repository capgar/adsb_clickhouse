apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallation
metadata:
  name: adsb-data
  namespace: adsb-clickhouse
spec:
  configuration:
    zookeeper:
      nodes:
        - host: adsb-keeper-headless.adsb-clickhouse.svc.cluster.local
          port: 2181
      root: /clickhouse/adsb-data
    
    clusters:
      - name: adsb-data
        layout:
          shardsCount: 1
          replicasCount: 1

    settings:
      prometheus/endpoint: /metrics
      prometheus/port: 9363
      prometheus/metrics: "true"
      prometheus/asynchronous_metrics: "true"
      prometheus/events: "true"

    users:
      default/networks/ip:
        - "127.0.0.1"
      admin/password_sha256_hex: <PASSWORD_SHA256>
      admin/networks/ip:
        - "::/0"
      admin/access_management: "1"
      admin/named_collection_control: "1"
      admin/show_named_collections_secrets: "1"

    files:
      kafka_collections.xml: |
        <clickhouse>
            <named_collections>
                <kafka_local>
                    <!-- ClickHouse Kafka engine parameters -->
                    <kafka_broker_list>lab.url:30192,lab.url:30193</kafka_broker_list>
                    <kafka_topic_list>positions-local</kafka_topic_list>
                    <kafka_group_name>clickhouse-lab-local</kafka_group_name>
                    <kafka_format>JSONEachRow</kafka_format>
                    <kafka_skip_broken_messages>1</kafka_skip_broken_messages>
                    <kafka_poll_timeout_ms>100</kafka_poll_timeout_ms>
                    <kafka_flush_interval_ms>2000</kafka_flush_interval_ms>   <!-- Flush every 2 sec instead of 7.5 -->
                    <kafka_max_block_size>1000</kafka_max_block_size>        <!-- Flush after 1K rows instead of 65K -->
                    <kafka_num_consumers>1</kafka_num_consumers>              <!-- Run 1 consumers -->
                    <!-- Kafka extended configuration (librdkafka settings) -->
                    <kafka>
                        <security_protocol>SSL</security_protocol>
                        <ssl_ca_location>/etc/clickhouse-kafka-tls/ca.crt</ssl_ca_location>
                        <ssl_certificate_location>/etc/clickhouse-kafka-tls/client.crt</ssl_certificate_location>
                        <ssl_key_location>/etc/clickhouse-kafka-tls/client.key</ssl_key_location>
                        <session_timeout_ms>60000</session_timeout_ms>
                        <max_poll_interval_ms>300000</max_poll_interval_ms>
                        <heartbeat_interval_ms>3000</heartbeat_interval_ms>
                        <auto_offset_reset>earliest</auto_offset_reset>
                    </kafka>
                </kafka_local>
                <kafka_regional>
                    <kafka_broker_list>lab.url:30192,lab.url:30193</kafka_broker_list>
                    <kafka_topic_list>positions-regional</kafka_topic_list>
                    <kafka_group_name>clickhouse-lab-regional</kafka_group_name>
                    <kafka_format>JSONEachRow</kafka_format>
                    <kafka_skip_broken_messages>10</kafka_skip_broken_messages>
                    <kafka_poll_timeout_ms>100</kafka_poll_timeout_ms>
                    <kafka_flush_interval_ms>5000</kafka_flush_interval_ms>
                    <kafka_max_block_size>20000</kafka_max_block_size>
                    <kafka_num_consumers>2</kafka_num_consumers>
                    <kafka>
                        <security_protocol>SSL</security_protocol>
                        <ssl_ca_location>/etc/clickhouse-kafka-tls/ca.crt</ssl_ca_location>
                        <ssl_certificate_location>/etc/clickhouse-kafka-tls/client.crt</ssl_certificate_location>
                        <ssl_key_location>/etc/clickhouse-kafka-tls/client.key</ssl_key_location>
                        <session_timeout_ms>60000</session_timeout_ms>
                        <max_poll_interval_ms>300000</max_poll_interval_ms>
                        <heartbeat_interval_ms>3000</heartbeat_interval_ms>
                        <auto_offset_reset>earliest</auto_offset_reset>
                    </kafka>
                </kafka_regional>
                <kafka_global_stream>
                    <kafka_broker_list>lab.url:30192,lab.url:30193</kafka_broker_list>
                    <kafka_topic_list>positions-global-stream</kafka_topic_list>
                    <kafka_group_name>clickhouse-lab-global-stream</kafka_group_name>
                    <kafka_format>JSONEachRow</kafka_format>
                    <kafka_skip_broken_messages>50</kafka_skip_broken_messages>
                    <kafka_poll_timeout_ms>100</kafka_poll_timeout_ms>
                    <kafka_flush_interval_ms>10000</kafka_flush_interval_ms>
                    <kafka_max_block_size>65000</kafka_max_block_size>
                    <kafka_num_consumers>3</kafka_num_consumers>
                    <kafka>
                        <security_protocol>SSL</security_protocol>
                        <ssl_ca_location>/etc/clickhouse-kafka-tls/ca.crt</ssl_ca_location>
                        <ssl_certificate_location>/etc/clickhouse-kafka-tls/client.crt</ssl_certificate_location>
                        <ssl_key_location>/etc/clickhouse-kafka-tls/client.key</ssl_key_location>
                        <session_timeout_ms>60000</session_timeout_ms>
                        <max_poll_interval_ms>300000</max_poll_interval_ms>
                        <heartbeat_interval_ms>3000</heartbeat_interval_ms>
                        <auto_offset_reset>earliest</auto_offset_reset>
                    </kafka>
                </kafka_global_stream>
                <kafka_global_opensky>
                    <kafka_broker_list>lab.url:30192,lab.url:30193</kafka_broker_list>
                    <kafka_topic_list>positions-global-opensky</kafka_topic_list>
                    <kafka_group_name>clickhouse-lab-global-opensky</kafka_group_name>
                    <kafka_format>JSONEachRow</kafka_format>
                    <kafka_skip_broken_messages>50</kafka_skip_broken_messages>
                    <kafka_poll_timeout_ms>100</kafka_poll_timeout_ms>
                    <kafka_flush_interval_ms>10000</kafka_flush_interval_ms>
                    <kafka_max_block_size>65000</kafka_max_block_size>
                    <kafka_num_consumers>2</kafka_num_consumers>
                    <kafka>
                        <security_protocol>SSL</security_protocol>
                        <ssl_ca_location>/etc/clickhouse-kafka-tls/ca.crt</ssl_ca_location>
                        <ssl_certificate_location>/etc/clickhouse-kafka-tls/client.crt</ssl_certificate_location>
                        <ssl_key_location>/etc/clickhouse-kafka-tls/client.key</ssl_key_location>
                        <session_timeout_ms>60000</session_timeout_ms>
                        <max_poll_interval_ms>300000</max_poll_interval_ms>
                        <heartbeat_interval_ms>3000</heartbeat_interval_ms>
                        <auto_offset_reset>earliest</auto_offset_reset>
                    </kafka>
                </kafka_global_opensky>
            </named_collections>
        </clickhouse>

    profiles:
      default/max_memory_usage: "4000000000"
      default/joined_subquery_requires_alias: "0"

  defaults:
    replicasUseFQDN: "yes"
    templates:
      podTemplate: clickhouse-pod
      dataVolumeClaimTemplate: data-volume
      logVolumeClaimTemplate: log-volume
      serviceTemplate: external-service

  templates:
    podTemplates:
      - name: clickhouse-pod
        spec:
          affinity:
            nodeAffinity:
              # Prefer designated nodes
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  preference:
                    matchExpressions:
                      - key: adsb-clickhouse
                        operator: Exists
            podAntiAffinity:
              # spread ClickHouse pods across different nodes for HA
              # optional to allow for single instance labs
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  podAffinityTerm:
                    labelSelector:
                      matchExpressions:
                        - key: clickhouse.altinity.com/chi
                          operator: In
                          values:
                            - adsb-data
                    topologyKey: kubernetes.io/hostname
          containers:
            - name: clickhouse
              image: altinity/clickhouse-server:25.3.8.10041.altinitystable
              ports:
                - name: metrics
                  containerPort: 9363
                  protocol: TCP
              volumeMounts:
                - name: kafka-tls-certs
                  mountPath: /etc/clickhouse-kafka-tls
                  readOnly: true
          securityContext:
            runAsUser: 101
            runAsGroup: 101
            fsGroup: 101
          volumes:
            - name: kafka-tls-certs
              secret:
                secretName: kafka-client-tls
                defaultMode: 288

    serviceTemplates:
      - name: external-service
        spec:
          type: NodePort
          ports:
            - name: http
              port: 8123
              nodePort: 30123
            - name: tcp
              port: 9000
              nodePort: 30900
            - name: metrics
              port: 9363
              nodePort: 30363

    volumeClaimTemplates:
      - name: data-volume
        spec:
          accessModes: [ReadWriteOnce]
          storageClassName: local-path
          resources:
            requests:
              storage: 100Gi
      - name: log-volume
        spec:
          accessModes: [ReadWriteOnce]
          storageClassName: local-path
          resources:
            requests:
              storage: 10Gi