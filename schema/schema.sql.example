-- ============================================================================
-- ADS-B ClickHouse Schema V3.1
-- Simplified two-layer architecture with batch-level scrape timing:
--   1. Long-term storage (positions_<source>)
--   2. Current state with deduplication (positions_<source>_replacing)
--   3. Latest batch views (positions_<source>_latest)
-- ============================================================================

CREATE DATABASE IF NOT EXISTS adsb ON CLUSTER `adsb-data`;
USE adsb;

-- ============================================================================
-- KAFKA TABLES (Match scraper output exactly)
-- ============================================================================

-- Local Kafka (all fields from local ADS-B receiver's API)
CREATE TABLE IF NOT EXISTS positions_local_kafka ON CLUSTER `adsb-data` (
    -- Core identification
    hex String,
    type String,
    flight String,
    r String,
    t String,
    desc String,
    -- Position data
    lat Nullable(Float64),
    lon Nullable(Float64),
    alt_baro String,
    alt_geom String,
    gs Nullable(Float32),
    track Nullable(Float32),
    baro_rate Nullable(Float32),
    -- Status
    squawk String,
    emergency String,
    category String,
    -- Navigation
    nav_qnh Nullable(Float32),
    nav_altitude_mcp Nullable(Int32),
    -- Quality indicators
    nic Nullable(Int32),
    rc Nullable(Int32),
    version Nullable(Int32),
    nic_baro Nullable(Int32),
    nac_p Nullable(Int32),
    nac_v Nullable(Int32),
    sil Nullable(Int32),
    sil_type String,
    gva Nullable(Int32),
    sda Nullable(Int32),
    -- Alerts
    alert Nullable(Int32),
    spi Nullable(Int32),
    -- Timing
    seen_pos Nullable(Float32),
    seen Nullable(Float32),
    -- Local-specific
    rssi Nullable(Float32),
    messages Nullable(Int32),
    r_dst Nullable(Float32),
    r_dir Nullable(Float32),
    ownOp String,
    year String,
    -- Metadata
    source String,
    scrape_time DateTime
) ENGINE = Kafka(kafka_local);

-- Regional Kafka (all fields from regional API)
CREATE TABLE IF NOT EXISTS positions_regional_kafka ON CLUSTER `adsb-data` (
    -- Core identification
    hex String,
    type String,
    flight String,
    r String,
    t String,
    desc String,
    -- Position data
    lat Nullable(Float64),
    lon Nullable(Float64),
    alt_baro String,
    alt_geom String,
    gs Nullable(Float32),
    track Nullable(Float32),
    baro_rate Nullable(Float32),
    -- Status
    squawk String,
    emergency String,
    category String,
    -- Navigation
    nav_qnh Nullable(Float32),
    nav_altitude_mcp Nullable(Int32),
    nav_modes Array(String),
    -- Quality indicators
    nic Nullable(Int32),
    rc Nullable(Int32),
    version Nullable(Int32),
    nic_baro Nullable(Int32),
    nac_p Nullable(Int32),
    nac_v Nullable(Int32),
    sil Nullable(Int32),
    sil_type String,
    gva Nullable(Int32),
    sda Nullable(Int32),
    -- Alerts
    alert Nullable(Int32),
    spi Nullable(Int32),
    -- Timing
    seen_pos Nullable(Float32),
    seen Nullable(Float32),
    -- Regional-specific
    rssi Nullable(Float32),
    messages Nullable(Int32),
    dst Nullable(Float32),
    dir Nullable(Float32),
    ownOp String,
    year String,
    -- Metadata
    source String,
    scrape_time DateTime
) ENGINE = Kafka(kafka_regional);

-- Global Kafka (all fields from global API)
CREATE TABLE IF NOT EXISTS positions_global_kafka ON CLUSTER `adsb-data` (
    -- Core identification
    hex String,
    type String,
    flight String,
    r String,
    t String,
    desc String,
    -- Position data
    lat Nullable(Float64),
    lon Nullable(Float64),
    alt_baro String,
    alt_geom String,
    gs Nullable(Float32),
    track Nullable(Float32),
    baro_rate Nullable(Float32),
    -- Status
    squawk String,
    emergency String,
    category String,
    -- Navigation
    nav_qnh Nullable(Float32),
    nav_altitude_mcp Nullable(Int32),
    nav_modes Array(String),
    -- Quality indicators
    nic Nullable(Int32),
    rc Nullable(Int32),
    version Nullable(Int32),
    nic_baro Nullable(Int32),
    nac_p Nullable(Int32),
    nac_v Nullable(Int32),
    sil Nullable(Int32),
    sil_type String,
    gva Nullable(Int32),
    sda Nullable(Int32),
    -- Alerts
    alert Nullable(Int32),
    spi Nullable(Int32),
    -- Timing
    seen_pos Nullable(Float32),
    seen Nullable(Float32),
    -- Global-specific
    rssi Nullable(Float32),
    messages Nullable(Int32),
    dst Nullable(Float32),
    dir Nullable(Float32),
    -- Metadata
    source String,
    scrape_time DateTime
) ENGINE = Kafka(kafka_global);

-- ============================================================================
-- LONG-TERM STORAGE TABLES (Historical data with appropriate TTL)
-- ============================================================================

-- Local storage (1 year retention - highest value data)
CREATE TABLE IF NOT EXISTS positions_local ON CLUSTER `adsb-data` (
    -- Core identification
    icao24 String,
    type String,
    callsign String,
    registration String,
    aircraft_type String,
    description String,
    -- Position data
    lat Nullable(Float64),
    lon Nullable(Float64),
    alt_baro Nullable(Int32),
    alt_geom Nullable(Int32),
    ground_speed Nullable(Float32),
    track Nullable(Float32),
    vertical_rate Nullable(Float32),
    -- Status
    squawk String,
    emergency String,
    category String,
    -- Navigation
    nav_qnh Nullable(Float32),
    nav_altitude_mcp Nullable(Int32),
    -- Quality indicators
    nic Nullable(Int32),
    rc Nullable(Int32),
    version Nullable(Int32),
    nic_baro Nullable(Int32),
    nac_p Nullable(Int32),
    nac_v Nullable(Int32),
    sil Nullable(Int32),
    sil_type String,
    gva Nullable(Int32),
    sda Nullable(Int32),
    -- Alerts
    alert Nullable(Int32),
    spi Nullable(Int32),
    -- Timing
    seen_pos Nullable(Float32),
    seen Nullable(Float32),
    -- Local-specific
    rssi Nullable(Float32),
    messages Nullable(Int32),
    range_distance Nullable(Float32),
    range_direction Nullable(Float32),
    owner_operator String,
    year String,
    -- Metadata
    scrape_time DateTime,
    ingestion_time DateTime
) ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/positions_local', '{replica}')
PARTITION BY toYYYYMMDD(scrape_time)
ORDER BY (icao24, scrape_time)
TTL scrape_time + INTERVAL 180 DAY
SETTINGS index_granularity = 8192;

-- Regional storage (90 days retention)
CREATE TABLE IF NOT EXISTS positions_regional ON CLUSTER `adsb-data` (
    -- Core identification
    icao24 String,
    type String,
    callsign String,
    registration String,
    aircraft_type String,
    description String,
    -- Position data
    lat Nullable(Float64),
    lon Nullable(Float64),
    alt_baro Nullable(Int32),
    alt_geom Nullable(Int32),
    ground_speed Nullable(Float32),
    track Nullable(Float32),
    vertical_rate Nullable(Float32),
    -- Status
    squawk String,
    emergency String,
    category String,
    -- Navigation
    nav_qnh Nullable(Float32),
    nav_altitude_mcp Nullable(Int32),
    nav_modes Array(String),
    -- Quality indicators
    nic Nullable(Int32),
    rc Nullable(Int32),
    version Nullable(Int32),
    nic_baro Nullable(Int32),
    nac_p Nullable(Int32),
    nac_v Nullable(Int32),
    sil Nullable(Int32),
    sil_type String,
    gva Nullable(Int32),
    sda Nullable(Int32),
    -- Alerts
    alert Nullable(Int32),
    spi Nullable(Int32),
    -- Timing
    seen_pos Nullable(Float32),
    seen Nullable(Float32),
    -- Regional-specific
    rssi Nullable(Float32),
    messages Nullable(Int32),
    distance Nullable(Float32),
    direction Nullable(Float32),
    owner_operator String,
    year String,
    -- Metadata
    scrape_time DateTime,
    ingestion_time DateTime
) ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/positions_regional', '{replica}')
PARTITION BY toYYYYMMDD(scrape_time)
ORDER BY (icao24, scrape_time)
TTL scrape_time + INTERVAL 90 DAY
SETTINGS index_granularity = 8192;

-- Global storage (7 days retention)
CREATE TABLE IF NOT EXISTS positions_global ON CLUSTER `adsb-data` (
    -- Core identification
    icao24 String,
    type String,
    callsign String,
    registration String,
    aircraft_type String,
    description String,
    -- Position data
    lat Nullable(Float64),
    lon Nullable(Float64),
    alt_baro Nullable(Int32),
    alt_geom Nullable(Int32),
    ground_speed Nullable(Float32),
    track Nullable(Float32),
    vertical_rate Nullable(Float32),
    -- Status
    squawk String,
    emergency String,
    category String,
    -- Navigation
    nav_qnh Nullable(Float32),
    nav_altitude_mcp Nullable(Int32),
    nav_modes Array(String),
    -- Quality indicators
    nic Nullable(Int32),
    rc Nullable(Int32),
    version Nullable(Int32),
    nic_baro Nullable(Int32),
    nac_p Nullable(Int32),
    nac_v Nullable(Int32),
    sil Nullable(Int32),
    sil_type String,
    gva Nullable(Int32),
    sda Nullable(Int32),
    -- Alerts
    alert Nullable(Int32),
    spi Nullable(Int32),
    -- Timing
    seen_pos Nullable(Float32),
    seen Nullable(Float32),
    -- Global-specific
    rssi Nullable(Float32),
    messages Nullable(Int32),
    distance Nullable(Float32),
    direction Nullable(Float32),
    -- Metadata
    scrape_time DateTime,
    ingestion_time DateTime
) ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/positions_global', '{replica}')
PARTITION BY toYYYYMMDD(scrape_time)
ORDER BY (icao24, scrape_time)
TTL scrape_time + INTERVAL 30 DAY
SETTINGS index_granularity = 8192;

-- ============================================================================
-- MATERIALIZED VIEWS: Kafka → Long-term Storage
-- ============================================================================

CREATE MATERIALIZED VIEW IF NOT EXISTS positions_local_mv ON CLUSTER `adsb-data` TO positions_local AS
SELECT
    hex as icao24,
    type,
    flight as callsign,
    r as registration,
    t as aircraft_type,
    desc as description,
    lat,
    lon,
    if(alt_baro = 'ground', 0, toInt32OrNull(alt_baro)) as alt_baro,
    if(alt_geom = 'ground', 0, toInt32OrNull(alt_geom)) as alt_geom,
    gs as ground_speed,
    track,
    baro_rate as vertical_rate,
    squawk,
    emergency,
    category,
    nav_qnh,
    nav_altitude_mcp,
    nic,
    rc,
    version,
    nic_baro,
    nac_p,
    nac_v,
    sil,
    sil_type,
    gva,
    sda,
    alert,
    spi,
    seen_pos,
    seen,
    rssi,
    messages,
    r_dst as range_distance,
    r_dir as range_direction,
    ownOp as owner_operator,
    year,
    scrape_time,
    now() as ingestion_time
FROM positions_local_kafka
WHERE lat IS NOT NULL AND lon IS NOT NULL;

CREATE MATERIALIZED VIEW IF NOT EXISTS positions_regional_mv ON CLUSTER `adsb-data` TO positions_regional AS
SELECT
    hex as icao24,
    type,
    flight as callsign,
    r as registration,
    t as aircraft_type,
    desc as description,
    lat,
    lon,
    if(alt_baro = 'ground', 0, toInt32OrNull(alt_baro)) as alt_baro,
    if(alt_geom = 'ground', 0, toInt32OrNull(alt_geom)) as alt_geom,
    gs as ground_speed,
    track,
    baro_rate as vertical_rate,
    squawk,
    emergency,
    category,
    nav_qnh,
    nav_altitude_mcp,
    nav_modes,
    nic,
    rc,
    version,
    nic_baro,
    nac_p,
    nac_v,
    sil,
    sil_type,
    gva,
    sda,
    alert,
    spi,
    seen_pos,
    seen,
    rssi,
    messages,
    dst as distance,
    dir as direction,
    ownOp as owner_operator,
    year,
    scrape_time,
    now() as ingestion_time
FROM positions_regional_kafka
WHERE lat IS NOT NULL AND lon IS NOT NULL;

CREATE MATERIALIZED VIEW IF NOT EXISTS positions_global_mv ON CLUSTER `adsb-data` TO positions_global AS
SELECT
    hex as icao24,
    type,
    flight as callsign,
    r as registration,
    t as aircraft_type,
    desc as description,
    lat,
    lon,
    if(alt_baro = 'ground', 0, toInt32OrNull(alt_baro)) as alt_baro,
    if(alt_geom = 'ground', 0, toInt32OrNull(alt_geom)) as alt_geom,
    gs as ground_speed,
    track,
    baro_rate as vertical_rate,
    squawk,
    emergency,
    category,
    nav_qnh,
    nav_altitude_mcp,
    nav_modes,
    nic,
    rc,
    version,
    nic_baro,
    nac_p,
    nac_v,
    sil,
    sil_type,
    gva,
    sda,
    alert,
    spi,
    seen_pos,
    seen,
    rssi,
    messages,
    dst as distance,
    dir as direction,
    scrape_time,
    now() as ingestion_time
FROM positions_global_kafka
WHERE lat IS NOT NULL AND lon IS NOT NULL;

-- ============================================================================
-- REPLACING TABLES (Current state with deduplication by icao24)
-- ============================================================================

-- Local replacing (deduplicated by icao24, keeps newest scrape_time)
CREATE TABLE IF NOT EXISTS positions_local_replacing ON CLUSTER `adsb-data` (
    -- Core identification
    icao24 String,
    type String,
    callsign String,
    registration String,
    aircraft_type String,
    description String,
    -- Position data
    lat Nullable(Float64),
    lon Nullable(Float64),
    alt_baro Nullable(Int32),
    alt_geom Nullable(Int32),
    ground_speed Nullable(Float32),
    track Nullable(Float32),
    vertical_rate Nullable(Float32),
    -- Status
    squawk String,
    emergency String,
    category String,
    -- Navigation
    nav_qnh Nullable(Float32),
    nav_altitude_mcp Nullable(Int32),
    -- Quality indicators
    nic Nullable(Int32),
    rc Nullable(Int32),
    version Nullable(Int32),
    nic_baro Nullable(Int32),
    nac_p Nullable(Int32),
    nac_v Nullable(Int32),
    sil Nullable(Int32),
    sil_type String,
    gva Nullable(Int32),
    sda Nullable(Int32),
    -- Alerts
    alert Nullable(Int32),
    spi Nullable(Int32),
    -- Timing
    seen_pos Nullable(Float32),
    seen Nullable(Float32),
    -- Local-specific
    rssi Nullable(Float32),
    messages Nullable(Int32),
    range_distance Nullable(Float32),
    range_direction Nullable(Float32),
    owner_operator String,
    year String,
    -- Timing metadata
    scrape_time DateTime,
    ingestion_time DateTime
) ENGINE = ReplicatedReplacingMergeTree('/clickhouse/tables/{shard}/positions_local_replacing', '{replica}', scrape_time)
ORDER BY icao24
TTL scrape_time + INTERVAL 1 HOUR
SETTINGS index_granularity = 8192;

-- Regional replacing (deduplicated by icao24, keeps newest scrape_time)
CREATE TABLE IF NOT EXISTS positions_regional_replacing ON CLUSTER `adsb-data` (
    -- Core identification
    icao24 String,
    type String,
    callsign String,
    registration String,
    aircraft_type String,
    description String,
    -- Position data
    lat Nullable(Float64),
    lon Nullable(Float64),
    alt_baro Nullable(Int32),
    alt_geom Nullable(Int32),
    ground_speed Nullable(Float32),
    track Nullable(Float32),
    vertical_rate Nullable(Float32),
    -- Status
    squawk String,
    emergency String,
    category String,
    -- Navigation
    nav_qnh Nullable(Float32),
    nav_altitude_mcp Nullable(Int32),
    nav_modes Array(String),
    -- Quality indicators
    nic Nullable(Int32),
    rc Nullable(Int32),
    version Nullable(Int32),
    nic_baro Nullable(Int32),
    nac_p Nullable(Int32),
    nac_v Nullable(Int32),
    sil Nullable(Int32),
    sil_type String,
    gva Nullable(Int32),
    sda Nullable(Int32),
    -- Alerts
    alert Nullable(Int32),
    spi Nullable(Int32),
    -- Timing
    seen_pos Nullable(Float32),
    seen Nullable(Float32),
    -- Regional-specific
    rssi Nullable(Float32),
    messages Nullable(Int32),
    distance Nullable(Float32),
    direction Nullable(Float32),
    owner_operator String,
    year String,
    -- Timing metadata
    scrape_time DateTime,
    ingestion_time DateTime
) ENGINE = ReplicatedReplacingMergeTree('/clickhouse/tables/{shard}/positions_regional_replacing', '{replica}', scrape_time)
ORDER BY icao24
TTL scrape_time + INTERVAL 1 HOUR
SETTINGS index_granularity = 8192;

-- Global replacing (deduplicated by icao24, keeps newest scrape_time)
CREATE TABLE IF NOT EXISTS positions_global_replacing ON CLUSTER `adsb-data` (
    -- Core identification
    icao24 String,
    type String,
    callsign String,
    registration String,
    aircraft_type String,
    description String,
    -- Position data
    lat Nullable(Float64),
    lon Nullable(Float64),
    alt_baro Nullable(Int32),
    alt_geom Nullable(Int32),
    ground_speed Nullable(Float32),
    track Nullable(Float32),
    vertical_rate Nullable(Float32),
    -- Status
    squawk String,
    emergency String,
    category String,
    -- Navigation
    nav_qnh Nullable(Float32),
    nav_altitude_mcp Nullable(Int32),
    nav_modes Array(String),
    -- Quality indicators
    nic Nullable(Int32),
    rc Nullable(Int32),
    version Nullable(Int32),
    nic_baro Nullable(Int32),
    nac_p Nullable(Int32),
    nac_v Nullable(Int32),
    sil Nullable(Int32),
    sil_type String,
    gva Nullable(Int32),
    sda Nullable(Int32),
    -- Alerts
    alert Nullable(Int32),
    spi Nullable(Int32),
    -- Timing
    seen_pos Nullable(Float32),
    seen Nullable(Float32),
    -- Global-specific
    rssi Nullable(Float32),
    messages Nullable(Int32),
    distance Nullable(Float32),
    direction Nullable(Float32),
    -- Timing metadata
    scrape_time DateTime,
    ingestion_time DateTime
) ENGINE = ReplicatedReplacingMergeTree('/clickhouse/tables/{shard}/positions_global_replacing', '{replica}', scrape_time)
ORDER BY icao24
TTL scrape_time + INTERVAL 1 HOUR
SETTINGS index_granularity = 8192;

-- ============================================================================
-- MATERIALIZED VIEWS: Long-term Storage → Replacing Tables
-- ============================================================================

CREATE MATERIALIZED VIEW IF NOT EXISTS positions_local_replacing_mv ON CLUSTER `adsb-data` TO positions_local_replacing AS
SELECT
    icao24,
    type,
    callsign,
    registration,
    aircraft_type,
    description,
    lat,
    lon,
    alt_baro,
    alt_geom,
    ground_speed,
    track,
    vertical_rate,
    squawk,
    emergency,
    category,
    nav_qnh,
    nav_altitude_mcp,
    nic,
    rc,
    version,
    nic_baro,
    nac_p,
    nac_v,
    sil,
    sil_type,
    gva,
    sda,
    alert,
    spi,
    seen_pos,
    seen,
    rssi,
    messages,
    range_distance,
    range_direction,
    owner_operator,
    year,
    scrape_time,
    ingestion_time
FROM positions_local
WHERE scrape_time > now() - INTERVAL 2 HOUR;

CREATE MATERIALIZED VIEW IF NOT EXISTS positions_regional_replacing_mv ON CLUSTER `adsb-data` TO positions_regional_replacing AS
SELECT
    icao24,
    type,
    callsign,
    registration,
    aircraft_type,
    description,
    lat,
    lon,
    alt_baro,
    alt_geom,
    ground_speed,
    track,
    vertical_rate,
    squawk,
    emergency,
    category,
    nav_qnh,
    nav_altitude_mcp,
    nav_modes,
    nic,
    rc,
    version,
    nic_baro,
    nac_p,
    nac_v,
    sil,
    sil_type,
    gva,
    sda,
    alert,
    spi,
    seen_pos,
    seen,
    rssi,
    messages,
    distance,
    direction,
    owner_operator,
    year,
    scrape_time,
    ingestion_time
FROM positions_regional
WHERE scrape_time > now() - INTERVAL 2 HOUR;

CREATE MATERIALIZED VIEW IF NOT EXISTS positions_global_replacing_mv ON CLUSTER `adsb-data` TO positions_global_replacing AS
SELECT
    icao24,
    type,
    callsign,
    registration,
    aircraft_type,
    description,
    lat,
    lon,
    alt_baro,
    alt_geom,
    ground_speed,
    track,
    vertical_rate,
    squawk,
    emergency,
    category,
    nav_qnh,
    nav_altitude_mcp,
    nav_modes,
    nic,
    rc,
    version,
    nic_baro,
    nac_p,
    nac_v,
    sil,
    sil_type,
    gva,
    sda,
    alert,
    spi,
    seen_pos,
    seen,
    rssi,
    messages,
    distance,
    direction,
    scrape_time,
    ingestion_time
FROM positions_global
WHERE scrape_time > now() - INTERVAL 2 HOUR;

-- ============================================================================
-- LATEST BATCH VIEWS (Show only aircraft from most recent scrape)
-- ============================================================================

-- Local latest batch (all aircraft from most recent scrape)
CREATE VIEW IF NOT EXISTS positions_local_latest ON CLUSTER `adsb-data` AS
SELECT
    icao24,
    type,
    callsign,
    registration,
    aircraft_type,
    description,
    lat,
    lon,
    alt_baro,
    alt_geom,
    ground_speed,
    track,
    vertical_rate,
    squawk,
    emergency,
    category,
    nav_qnh,
    nav_altitude_mcp,
    nic,
    rc,
    version,
    nic_baro,
    nac_p,
    nac_v,
    sil,
    sil_type,
    gva,
    sda,
    alert,
    spi,
    seen_pos,
    seen,
    rssi,
    messages,
    range_distance,
    range_direction,
    owner_operator,
    year,
    scrape_time,
    ingestion_time
FROM positions_local_replacing FINAL
-- If adjusting scrape intervals, adjust this interval to > scrape interval
WHERE scrape_time > now() - INTERVAL 30 SECOND;

-- Regional latest batch (all aircraft from most recent scrape)
CREATE VIEW IF NOT EXISTS positions_regional_latest ON CLUSTER `adsb-data` AS
SELECT
    icao24,
    type,
    callsign,
    registration,
    aircraft_type,
    description,
    lat,
    lon,
    alt_baro,
    alt_geom,
    ground_speed,
    track,
    vertical_rate,
    squawk,
    emergency,
    category,
    nav_qnh,
    nav_altitude_mcp,
    nav_modes,
    nic,
    rc,
    version,
    nic_baro,
    nac_p,
    nac_v,
    sil,
    sil_type,
    gva,
    sda,
    alert,
    spi,
    seen_pos,
    seen,
    rssi,
    messages,
    distance,
    direction,
    owner_operator,
    year,
    scrape_time,
    ingestion_time
FROM positions_regional_replacing FINAL
-- If adjusting scrape intervals, adjust this interval to > scrape interval
WHERE scrape_time > now() - INTERVAL 1 MINUTE;

-- Global latest batch (all aircraft from most recent scrape)
CREATE VIEW IF NOT EXISTS positions_global_latest ON CLUSTER `adsb-data` AS
SELECT
    icao24,
    type,
    callsign,
    registration,
    aircraft_type,
    description,
    lat,
    lon,
    alt_baro,
    alt_geom,
    ground_speed,
    track,
    vertical_rate,
    squawk,
    emergency,
    category,
    nav_qnh,
    nav_altitude_mcp,
    nav_modes,
    nic,
    rc,
    version,
    nic_baro,
    nac_p,
    nac_v,
    sil,
    sil_type,
    gva,
    sda,
    alert,
    spi,
    seen_pos,
    seen,
    rssi,
    messages,
    distance,
    direction,
    scrape_time,
    ingestion_time
FROM positions_global_replacing FINAL
-- If adjusting scrape intervals, adjust this interval to > scrape interval
WHERE scrape_time > now() - INTERVAL 5 MINUTE;